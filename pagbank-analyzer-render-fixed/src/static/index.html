<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador PagBank Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .upload-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .dashboard {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .machine-card {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .machine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.3);
        }

        .machine-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .machine-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-tab {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .client-tab.active {
            display: block;
        }

        .back-button {
            background: #7c3aed;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .back-button:hover {
            background: #6d28d9;
        }

        .client-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .client-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }

        .client-card.bruto {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .client-card.custo {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .client-card.taxa {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .client-card.lucro {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .client-card-label {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .client-card-value {
            font-size: 24px;
            font-weight: bold;
        }

        .config-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .config-info {
            flex: 1;
        }

        .config-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .machine-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-item label {
            font-weight: bold;
            color: #333;
            min-width: 40px;
        }

        .config-item input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .config-item input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .config-item .percent {
            color: #666;
            font-size: 14px;
        }

        .outros-pagamentos {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .outros-title {
            font-size: 16px;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 15px;
        }

        .outros-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover {
            background: #7c3aed;
        }

        .transactions-section {
            margin-top: 30px;
        }

        .transactions-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .transactions-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #e5e7eb;
        }

        .transactions-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .transactions-table tr:hover {
            background: #f8f9fa;
        }

        .valor-positivo {
            color: #10b981;
            font-weight: bold;
        }

        .valor-negativo {
            color: #ef4444;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        #csvFile {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📊 Analisador PagBank Pro</h1>
            <p>Gestão completa de clientes, taxas e análise de lucro com dashboard organizado</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2>📂 Upload do Arquivo CSV</h2>
            <p>Selecione seu arquivo CSV do PagBank</p>
            <br>
            <input type="file" id="csvFile" accept=".csv" />
            <button class="upload-button" onclick="document.getElementById('csvFile').click()">
                📂 Selecionar Arquivo CSV
            </button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <h2>📊 Dashboard Geral</h2>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalMachines">0</div>
                    <div class="stat-label">Máquinas Ativas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTransactions">0</div>
                    <div class="stat-label">Total de Transações</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">R$ 0,00</div>
                    <div class="stat-label">Faturamento Total</div>
                </div>
            </div>

            <h3>🏷️ Suas Máquinas</h3>
            <div id="machinesGrid" class="machines-grid">
                <!-- Máquinas serão inseridas aqui -->
            </div>
        </div>

        <!-- Client Tab -->
        <div id="clientTab" class="client-tab">
            <button class="back-button" onclick="showDashboard()">← Voltar ao Dashboard</button>
            
            <!-- 4 Cards principais -->
            <div class="client-cards">
                <div class="client-card bruto">
                    <div class="client-card-label">Valor Bruto Total</div>
                    <div class="client-card-value" id="valorBrutoTotal">R$ 0,00</div>
                </div>
                <div class="client-card custo">
                    <div class="client-card-label">Taxas PagBank (Seu Custo)</div>
                    <div class="client-card-value" id="taxasPagBankTotal">R$ 0,00</div>
                </div>
                <div class="client-card taxa">
                    <div class="client-card-label">Suas Taxas (Cliente Paga)</div>
                    <div class="client-card-value" id="suasTaxasTotal">R$ 0,00</div>
                </div>
                <div class="client-card lucro">
                    <div class="client-card-label">Seu Lucro</div>
                    <div class="client-card-value" id="seuLucroTotal">R$ 0,00</div>
                </div>
            </div>

            <!-- Configuração de Taxas -->
            <div class="config-section">
                <div class="config-header">
                    <div class="config-info">
                        <div class="config-title">⚙️ Configure as Taxas que Você Cobra do Cliente</div>
                        <div class="machine-info">Máquina: <span id="currentMachineId">-</span></div>
                        <div class="machine-info">Empresa: <span id="currentClientName">-</span></div>
                    </div>
                </div>

                <div style="display: flex; gap: 30px;">
                    <!-- Cartão de Crédito -->
                    <div style="flex: 2;">
                        <h4 style="color: #3b82f6; margin-bottom: 15px;">💳 Cartão de Crédito</h4>
                        <div class="config-grid">
                            <div class="config-item">
                                <label>1x:</label>
                                <input type="number" id="credito_1x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>2x:</label>
                                <input type="number" id="credito_2x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>3x:</label>
                                <input type="number" id="credito_3x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>4x:</label>
                                <input type="number" id="credito_4x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>5x:</label>
                                <input type="number" id="credito_5x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>6x:</label>
                                <input type="number" id="credito_6x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>7x:</label>
                                <input type="number" id="credito_7x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>8x:</label>
                                <input type="number" id="credito_8x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>9x:</label>
                                <input type="number" id="credito_9x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>10x:</label>
                                <input type="number" id="credito_10x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>11x:</label>
                                <input type="number" id="credito_11x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>12x:</label>
                                <input type="number" id="credito_12x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>13x:</label>
                                <input type="number" id="credito_13x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>14x:</label>
                                <input type="number" id="credito_14x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>15x:</label>
                                <input type="number" id="credito_15x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>16x:</label>
                                <input type="number" id="credito_16x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>17x:</label>
                                <input type="number" id="credito_17x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>18x:</label>
                                <input type="number" id="credito_18x" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Outros Pagamentos -->
                    <div style="flex: 1;">
                        <h4 style="color: #f59e0b; margin-bottom: 15px;">🏦 Outros Pagamentos</h4>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="config-item">
                                <label>Débito:</label>
                                <input type="number" id="debito" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                            <div class="config-item">
                                <label>PIX:</label>
                                <input type="number" id="pix" step="0.01" min="0">
                                <span class="percent">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveClientConfig()">💾 Salvar Configurações</button>
                    <button class="btn btn-info" onclick="calculateProfit()">🧮 Calcular Lucro</button>
                    <button class="btn btn-purple" onclick="exportData()">📤 Exportar Dados</button>
                </div>
            </div>

            <!-- Transações Detalhadas -->
            <div class="transactions-section">
                <div class="transactions-title">
                    📋 Transações Detalhadas
                </div>
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Forma Pagamento</th>
                            <th>Parcelas</th>
                            <th>Valor Bruto</th>
                            <th>Valor Líquido</th>
                            <th>Taxa PagBank</th>
                            <th>Sua Taxa</th>
                            <th>Seu Lucro</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Transações serão inseridas aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let clientsData = [];
        let currentMachineId = null;

        // Configurar upload de arquivo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Página carregada, configurando upload...');
            
            const fileInput = document.getElementById('csvFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    console.log('📁 Arquivo selecionado:', event.target.files[0]);
                    if (event.target.files.length > 0) {
                        uploadFile(event.target.files[0]);
                    }
                });
                console.log('✅ Upload configurado com sucesso!');
            } else {
                console.error('❌ Elemento csvFile não encontrado!');
            }
        });

        function uploadFile(file) {
            console.log('📤 Iniciando upload do arquivo:', file.name);
            
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('📊 Resposta do upload:', data);
                
                if (data.success) {
                    clientsData = data.clients;
                    updateDashboard();
                    console.log(`✅ ${data.new_transactions} transações processadas`);
                } else {
                    console.error('❌ Erro no upload:', data.error);
                    alert('Erro ao processar arquivo: ' + data.error);
                }
            })
            .catch(error => {
                console.error('❌ Erro no upload:', error);
                alert('Erro ao enviar arquivo: ' + error.message);
            });
        }

        function updateDashboard() {
            console.log('🔄 Atualizando dashboard...');
            
            if (!clientsData || clientsData.length === 0) {
                console.log('❌ Nenhum dado de cliente disponível');
                return;
            }

            // Atualizar estatísticas gerais
            const totalMachines = clientsData.length;
            const totalTransactions = clientsData.reduce((sum, client) => sum + (client.total_transacoes || 0), 0);
            const totalRevenue = clientsData.reduce((sum, client) => sum + (client.valor_bruto_total || 0), 0);

            document.getElementById('totalMachines').textContent = totalMachines;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

            // Atualizar grid de máquinas
            const machinesGrid = document.getElementById('machinesGrid');
            machinesGrid.innerHTML = '';

            clientsData.forEach(client => {
                const machineCard = document.createElement('div');
                machineCard.className = 'machine-card';
                machineCard.onclick = () => openMachineTab(client.machine_id);
                
                machineCard.innerHTML = `
                    <div class="machine-title">🏷️ Máquina ${client.machine_id}</div>
                    <div class="machine-stats">
                        <div>
                            <div>Transações</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${client.total_transacoes || 0}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>Faturamento</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${formatCurrency(client.valor_bruto_total || 0)}</div>
                        </div>
                    </div>
                `;
                
                machinesGrid.appendChild(machineCard);
            });

            console.log('✅ Dashboard atualizado com sucesso!');
        }

        function openMachineTab(machineId) {
            console.log('🏷️ Abrindo aba da máquina:', machineId);
            
            currentMachineId = machineId;
            const client = clientsData.find(c => c.machine_id === machineId);
            
            if (!client) {
                console.error('❌ Cliente não encontrado:', machineId);
                return;
            }

            // Atualizar informações da máquina
            document.getElementById('currentMachineId').textContent = machineId;
            document.getElementById('currentClientName').textContent = client.client_name || 'N/A';

            // Atualizar cards principais
            document.getElementById('valorBrutoTotal').textContent = formatCurrency(client.valor_bruto_total || 0);
            document.getElementById('taxasPagBankTotal').textContent = formatCurrency(client.valor_taxa_total || 0);
            document.getElementById('suasTaxasTotal').textContent = 'R$ 0,00'; // Será calculado
            document.getElementById('seuLucroTotal').textContent = 'R$ 0,00'; // Será calculado

            // Carregar configurações salvas
            loadClientConfig(machineId);

            // Carregar transações
            loadTransactions(machineId);

            // Mostrar aba do cliente
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('clientTab').classList.add('active');
        }

        function showDashboard() {
            document.getElementById('clientTab').classList.remove('active');
            document.getElementById('dashboard').style.display = 'block';
            currentMachineId = null;
        }

        function loadClientConfig(machineId) {
            console.log('⚙️ Carregando configurações para máquina:', machineId);
            
            // Primeiro, limpar todos os campos para garantir isolamento
            for (let i = 1; i <= 18; i++) {
                const input = document.getElementById(`credito_${i}x`);
                if (input) {
                    input.value = '';
                }
            }
            document.getElementById('debito').value = '';
            document.getElementById('pix').value = '';
            
            fetch(`/api/client-config/${machineId}`)
                .then(response => response.json())
                .then(config => {
                    console.log('📋 Configurações carregadas:', config);
                    if (config) {
                        // Carregar configurações de crédito
                        for (let i = 1; i <= 18; i++) {
                            const input = document.getElementById(`credito_${i}x`);
                            if (input && config[`credito_${i}x`] !== undefined && config[`credito_${i}x`] !== null) {
                                input.value = config[`credito_${i}x`];
                                console.log(`✅ Carregado credito_${i}x: ${config[`credito_${i}x`]}%`);
                            }
                        }
                        
                        // Carregar outras configurações
                        if (config.debito !== undefined && config.debito !== null) {
                            document.getElementById('debito').value = config.debito;
                            console.log(`✅ Carregado débito: ${config.debito}%`);
                        }
                        if (config.pix !== undefined && config.pix !== null) {
                            document.getElementById('pix').value = config.pix;
                            console.log(`✅ Carregado PIX: ${config.pix}%`);
                        }
                    } else {
                        console.log('⚠️ Nenhuma configuração encontrada para esta máquina');
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao carregar configurações:', error);
                });
        }

        function saveClientConfig() {
            if (!currentMachineId) {
                alert('Nenhuma máquina selecionada');
                return;
            }

            console.log('💾 Salvando configurações para máquina:', currentMachineId);

            const config = {
                machine_id: currentMachineId
            };

            // Salvar configurações de crédito
            for (let i = 1; i <= 18; i++) {
                const input = document.getElementById(`credito_${i}x`);
                if (input && input.value && input.value.trim() !== '') {
                    config[`credito_${i}x`] = parseFloat(input.value);
                    console.log(`💳 Salvando credito_${i}x: ${input.value}%`);
                }
            }

            // Salvar outras configurações
            const debitoInput = document.getElementById('debito');
            const pixInput = document.getElementById('pix');
            
            if (debitoInput && debitoInput.value && debitoInput.value.trim() !== '') {
                config.debito = parseFloat(debitoInput.value);
                console.log(`💰 Salvando débito: ${debitoInput.value}%`);
            }
            if (pixInput && pixInput.value && pixInput.value.trim() !== '') {
                config.pix = parseFloat(pixInput.value);
                console.log(`🏦 Salvando PIX: ${pixInput.value}%`);
            }

            console.log('📤 Enviando configurações:', config);

            fetch(`/api/client-config/${currentMachineId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                console.log('📥 Resposta do servidor:', data);
                if (data.success) {
                    alert('Configurações salvas com sucesso!');
                } else {
                    alert('Erro ao salvar configurações: ' + data.error);
                }
            })
            .catch(error => {
                console.error('❌ Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações');
            });
        }

        function calculateProfit() {
            if (!currentMachineId) {
                alert('Nenhuma máquina selecionada');
                return;
            }

            console.log('🧮 Iniciando cálculo de lucro para máquina:', currentMachineId);

            fetch(`/api/calculate-profit/${currentMachineId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    console.log('📡 Resposta da API:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Dados recebidos:', data);
                    if (data.success) {
                        document.getElementById('suasTaxasTotal').textContent = formatCurrency(data.suas_taxas_total);
                        document.getElementById('seuLucroTotal').textContent = formatCurrency(data.lucro_total);
                        
                        // Atualizar tabela de transações com cálculos
                        updateTransactionsTable(data.transactions);
                        
                        alert('Lucro calculado com sucesso!');
                    } else {
                        console.error('❌ Erro da API:', data.error);
                        alert('Erro ao calcular lucro: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao calcular lucro:', error);
                    alert('Erro ao calcular lucro: ' + error.message);
                });
        }

        function loadTransactions(machineId) {
            console.log('🔄 Carregando transações para máquina:', machineId);
            
            fetch(`/api/transactions/${machineId}`)
                .then(response => {
                    console.log('📡 Resposta da API:', response.status);
                    return response.json();
                })
                .then(transactions => {
                    console.log('📊 Transações carregadas:', transactions);
                    if (Array.isArray(transactions)) {
                        updateTransactionsTable(transactions);
                    } else if (transactions.success === false) {
                        console.error('❌ Erro da API:', transactions.error);
                        updateTransactionsTable([]);
                    } else {
                        console.error('❌ Formato de resposta inesperado:', transactions);
                        updateTransactionsTable([]);
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao carregar transações:', error);
                    updateTransactionsTable([]);
                });
        }

        function updateTransactionsTable(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Nenhuma transação encontrada</td></tr>';
                return;
            }

            transactions.forEach(transaction => {
                // Calcular valor líquido: Valor Bruto - Sua Taxa
                const valorBruto = transaction.valor_bruto || 0;
                const suaTaxa = transaction.sua_taxa || 0;
                const valorLiquido = valorBruto - suaTaxa;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(transaction.data_transacao)}</td>
                    <td>${transaction.forma_pagamento}</td>
                    <td>${transaction.parcela || '-'}</td>
                    <td class="valor-positivo">${formatCurrency(valorBruto)}</td>
                    <td class="valor-positivo">${formatCurrency(valorLiquido)}</td>
                    <td class="valor-negativo">${formatCurrency(transaction.valor_taxa || 0)}</td>
                    <td class="valor-negativo">${formatCurrency(suaTaxa)}</td>
                    <td class="valor-positivo">${formatCurrency(transaction.seu_lucro || 0)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportData() {
            if (!currentMachineId) {
                alert('Nenhuma máquina selecionada');
                return;
            }

            fetch(`/api/export-data/${currentMachineId}`)
                .then(response => response.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `maquina_${currentMachineId}_dados.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Erro ao exportar dados:', error);
                    alert('Erro ao exportar dados');
                });
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return 'R$ 0,00';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>

